<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Reports - TreeSure</title>
  <link rel="stylesheet" href="css/reports.css" />
  <link rel="stylesheet" href="css/sidebar.css">
  <link rel="stylesheet" href="css/topbar.css">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Leaflet.js (optional for visualization) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>

<body onload="checkLogin()">
  <!-- Sidebar (loaded dynamically) -->
  <div id="sidebar-container"></div>



  <!-- Main Content -->
  <div class="main-content">
    <div class="top-horizontal-bar"> </div>


    <!-- Top Horizontal Bar -->

    <header>
      <h1>ğŸ“‘ Reports Dashboard</h1>
      <p>Comprehensive analytics and system summaries</p>
    </header>

    <!-- Export -->
    <section class="export-buttons">
      <h3>ğŸ“¤ Export Options</h3>
      <button id="exportPDF"><i class="fa-solid fa-file-pdf"></i> Export PDF</button>
      <button id="exportExcel"><i class="fa-solid fa-file-excel"></i> Export Excel</button>
      <button id="exportCSV"><i class="fa-solid fa-file-csv"></i> Export CSV</button>
      <button id="printReport"><i class="fa-solid fa-print"></i> Print</button>
      <button id="refreshData"><i class="fa-solid fa-refresh"></i> Refresh Data</button>
    </section>

    <!-- Tabs -->
    <section class="tabs">
      <button class="tab active" data-tab="trees">ğŸŒ³ Trees</button>
      <button class="tab" data-tab="ctpo">ğŸªª CTPO</button>
      <button class="tab" data-tab="pltp">ğŸªµ PLTP</button>
      <button class="tab" data-tab="splt">ğŸªµ SPLTP</button>
      <button class="tab" data-tab="ptc">ğŸ“‹ Permit to Cut</button>
      <button class="tab" data-tab="chainsaw">ğŸªš Chainsaw Permit</button>
    </section>

    <!-- Filters -->
    <h3>ğŸ” Filters & Search</h3>
    <section class="filters">
      <div class="filter-row">
        <input type="text" id="keywordSearch" placeholder="Search keyword..." />

        <select id="appointmentTypeFilter">
          <option value="all">All Appointment Types</option>
        </select>

        <select id="foresterFilter">
          <option value="all">All Foresters</option>
        </select>

        <select id="applicantFilter">
          <option value="all">All Applicants</option>
        </select>

        <select id="speciesFilter">
          <option value="all">All Species</option>
        </select>
      </div>
      
      <div class="date-range-filter">
        <label for="startDate">ğŸ“… From:</label>
        <input type="date" id="startDate" />
        <label for="endDate">ğŸ“… To:</label>
        <input type="date" id="endDate" />
      </div>
    </section>

    <!-- Data Table -->
    <section class="data-table" id="tableSection">
      <h3>ğŸ“‹ Detailed Data</h3>

      <!-- Loading Spinner -->
      <div id="loadingIndicator" style="display:none; text-align:center; padding:1em;">
        <i class="fa-solid fa-spinner fa-spin"></i> Loading reports...
      </div>

      <table id="reportTable">
        <!-- Header for Applications -->
        <thead id="applicationsHeader" style="display:none;">
          <tr>
            <th>Date</th>
            <th>Applicant</th>
            <th>Application Type</th>
            <th>Status</th>
            <th>Uploads</th>
            <th>Actions</th>
          </tr>
        </thead>

        <!-- Header for Trees/Appointments -->
        <thead id="treesHeader" style="display:none;">
          <tr>
            <th>Tree ID</th>
            <th>Appointment Type</th>
            <th>Applicant</th>
            <th>Species</th>
            <th>Diameter</th>
            <th>Height</th>
            <th>Volume</th>
            <th>Location</th>
            <th>Latitude</th>
            <th>Longitude</th>
            <th>Forester</th>
            <th>Status</th>
            <th>Date Tagged</th>
            <th>QR Code</th>
          </tr>
        </thead>

        <tbody>
          <tr>
            <td colspan="10">Loading data...</td>
          </tr>
        </tbody>
      </table>
    </section>

    <!-- Charts -->
    <section class="charts" id="chartsSection">
      <h3>ğŸ“Š Visual Analytics</h3>
      <div class="charts-grid">
        <div class="chart-box">
          <h3>ğŸ“Š Application Status Distribution</h3>
          <canvas id="statusChart"></canvas>
        </div>
        <div class="chart-box">
          <h3>ğŸŒ¿ Tree Species Distribution</h3>
          <canvas id="speciesChart"></canvas>
        </div>
      </div>
    </section>

    <!-- Admin Controls -->
    <section class="admin-controls" id="adminSection">
      <h3>âš™ï¸ Report Settings</h3>
      <label><input type="checkbox" id="autoRefresh" /> Auto-refresh reports</label>
      </label>
    </section>
  </div>

  <!-- Application Details Modal -->
  <div id="applicationDetailsModal" class="modal" style="display:none;">
    <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
      <span class="close" id="closeDetailsModal">&times;</span>
      <h2>Application Details</h2>

      <div id="applicationDetailsContent">
        <!-- Content will be populated dynamically -->
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script type="module" src="./js/reports.js"></script>


  <!-- Load Sidebar Dynamically -->
  <script>
    fetch("sidebar.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("sidebar-container").innerHTML = html;

        // Highlight the active page link
        const current = window.location.pathname.split("/").pop();
        document.querySelectorAll(".sidebar a").forEach(link => {
          if (link.getAttribute("href") === current) {
            link.classList.add("active");
          }
        });

        // Logout handler
        const logoutBtn = document.getElementById("logoutBtn");
        if (logoutBtn) {
          logoutBtn.addEventListener("click", e => {
            e.preventDefault();
            localStorage.clear();
            window.location.href = "login.html";
          });
        }

        // --------- ADD DROPDOWN FUNCTIONALITY ---------

        // Main Applications dropdown
        document.querySelectorAll(".dropdown-toggle").forEach(drop => {
          drop.addEventListener("click", e => {
            e.preventDefault(); // prevent link jump
            e.stopPropagation(); // prevent event bubbling

            // Close other dropdowns first
            document.querySelectorAll(".dropdown.open").forEach(openDropdown => {
              if (openDropdown !== drop.parentElement) {
                openDropdown.classList.remove("open");
              }
            });

            drop.parentElement.classList.toggle("open");
          });
        });

        // Sub-dropdown (Cutting Permit)
        document.querySelectorAll(".sub-toggle").forEach(sub => {
          sub.addEventListener("click", e => {
            e.preventDefault();
            e.stopPropagation(); // prevent event bubbling
            const subMenu = sub.nextElementSibling;
            subMenu.classList.toggle("open");
          });
        });

        // Close dropdown when clicking outside
        document.addEventListener("click", e => {
          if (!e.target.closest(".dropdown")) {
            document.querySelectorAll(".dropdown.open").forEach(dropdown => {
              dropdown.classList.remove("open");
            });
          }
        });

        // ---------- APPLICATION TYPE BUTTONS ----------
        // When clicking application type buttons, navigate to applications.html
        const appButtons = [
          { id: "ctpoBtn", type: "ctpo", title: "CTPO Applications" },
          { id: "pltpBtn", type: "pltp", title: "PLTP Applications" },
          { id: "spltpBtn", type: "spltp", title: "SPLTP Applications" },
          { id: "permitCutBtn", type: "ptc", title: "Permit to Cut Applications" },
          { id: "cttBtn", type: "ctt", title: "Transport Permit (CTT)" },
          { id: "chainsawBtn", type: "chainsaw", title: "Chainsaw Registration" },
        ];

        appButtons.forEach(btn => {
          const element = document.getElementById(btn.id);
          if (element) {
            element.addEventListener("click", () => {
              localStorage.setItem("selectedApplicationType", btn.type);
              localStorage.setItem("selectedApplicationTitle", btn.title);
              window.location.href = "applications.html";
            });
          }
        });

        // ---------------------------------------------
      });

  </script>

  <script type="module" src="js/application-temp-fix.js"></script>

  <!-- ğŸ“¤ Export Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.6.0/jspdf.plugin.autotable.min.js"></script>
</body>

</html>